# Define a custom network for all services
networks:
  scmlite-net:
    driver: bridge

services:
  # ------------------------------------
  # 1. ZOOKEEPER SERVICE (External Image)
  # ------------------------------------
  zookeeper:
    image: confluentinc/cp-zookeeper:7.0.1
    container_name: zookeeper
    ports:
      - "2181:2181"
    environment:
      ZOOKEEPER_CLIENT_PORT: 2181
      ZOOKEEPER_TICK_TIME: 2000
    networks:
      - scmlite-net

  # ----------------------------------
  # 2. KAFKA SERVICE (External Image)
  # ----------------------------------
  kafka:
    image: confluentinc/cp-kafka:7.0.1
    container_name: kafka
    ports:
      - "9092:9092"
    environment:
      KAFKA_ZOOKEEPER_CONNECT: zookeeper:2181
      # IMPORTANT: Use the service name 'kafka' for internal communication
      KAFKA_ADVERTISED_LISTENERS: PLAINTEXT://kafka:9092
      KAFKA_LISTENERS: PLAINTEXT://0.0.0.0:9092
      KAFKA_OFFSETS_TOPIC_REPLICATION_FACTOR: 1
    depends_on:
      - zookeeper
    networks:
      - scmlite-net

  # ------------------------------------
  # 3. WEB APPLICATION (FastAPI/Uvicorn)
  # Uses Dockerfile.web
  # ------------------------------------
  web-app:
    # --- DOCKER HUB TAG ---
    image: jaisankar123/scm-backend:latest
    # build:
    #   context: .
    #   dockerfile: Dockerfile.web
    # -----------------------------
    container_name: scm-web-app
    entrypoint: python
    command: ["-m", "uvicorn", "main:app", "--host", "0.0.0.0", "--port", "8000"]
    ports:
      - "80:8000" # Map container port 8000 to host port 80
    depends_on:
      - consumer
      - kafka
    environment:
      # Use service names as hostnames for internal connections
      KAFKA_BOOTSTRAP_SERVERS: kafka:9092
      MONGODB_URI: ${MONGODB_URI}
      JWT_SECRET_KEY: ${JWT_SECRET_KEY}
    networks:
      - scmlite-net

  # ------------------------------------
  # 4. DATA SERVER (Socket Generator)
  # Uses Dockerfile.data
  # ------------------------------------
  data-server:
    # --- DOCKER HUB TAG ---
    image: jaisankar123/scm-server:latest
    # build:
    #   context: .
    #   dockerfile: Dockerfile.data # <-- CORRECTED
    # -----------------------------
    container_name: scm-data-server
    command: ["server.py"] # Run your server script
    # Expose the socket port (5050) for the producer to connect to
    ports:
      - "5050:5050"
    networks:
      - scmlite-net

  # ------------------------------------
  # 5. DATA PRODUCER (Connects to Server & Kafka)
  # Uses Dockerfile.data
  # ------------------------------------
  producer:
    # --- DOCKER HUB TAG ---
    image: jaisankar123/scm-producer:latest
    # build:
    #   context: .
    #   dockerfile: Dockerfile.data # <-- CORRECTED
    # -----------------------------
    container_name: scm-producer
    command: ["producer.py"] # Run your producer script
    depends_on:
      - kafka
      - data-server # Ensure the socket server is running first
    environment:
      KAFKA_TOPIC: device_stream_data
      # Set KAFKA_BOOTSTRAP_SERVERS to the correct service name
      KAFKA_BOOTSTRAP_SERVERS: kafka:9092
      # Set SOCKET_SERVER to the correct service name
      SOCKET_SERVER: data-server
      SOCKET_PORT: 5050
      BUFFER_SIZE: 4096
    networks:
      - scmlite-net

  # ------------------------------------
  # 6. DATA CONSUMER (Connects to Kafka & MongoDB)
  # Uses Dockerfile.consumer
  # ------------------------------------
  consumer:
    # --- DOCKER HUB TAG ---
    image: jaisankar123/scm-consumer:latest
    # build:
    #   context: .
    #   dockerfile: Dockerfile.consumer
    # -----------------------------
    container_name: scm-consumer
    command: ["consumer.py"] # Assuming you have a consumer.py script
    depends_on:
      - kafka
    environment:
      # Use the Kafka service name
      KAFKA_BOOTSTRAP_SERVERS: kafka:9092
      MONGODB_URI: ${MONGODB_URI}
    networks:
      - scmlite-net