<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>My Account</title>
    <link rel="stylesheet" href="login.css" /> 
    <style>
        /* Basic styling for myaccount components (you'll want to move this to a proper CSS file) */
        .profile-container {
            display: flex;
            align-items: center;
            margin-bottom: 20px;
        }
        .user-initial {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            background-color: #00bcd4; /* Neon blue color */
            color: white;
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 28px;
            font-weight: bold;
            margin-right: 20px;
        }
        .user-info h3 {
            margin: 0;
            color: #00bcd4;
        }
        .user-info p {
            margin: 5px 0 0 0;
            color: #ccc;
        }
        .details-container {
            padding: 20px;
            border: 1px solid #00bcd4;
            border-radius: 8px;
            background-color: #1a1a1a;
        }
        .help-section {
            margin-top: 30px;
        }
        #messageForm {
            display: none; /* Hidden by default */
            margin-top: 15px;
            padding: 15px;
            border: 1px solid #7af58b;
            border-radius: 5px;
            background-color: #0f0f0f;
        }
        #messageForm textarea {
            width: 100%;
            min-height: 100px;
            padding: 10px;
            margin-bottom: 10px;
            border: 1px solid #444;
            background-color: #222;
            color: white;
            box-sizing: border-box;
            resize: vertical;
        }
        #messageForm button {
            background-color: #7af58b;
            color: black;
            border: none;
            padding: 10px 15px;
            cursor: pointer;
            border-radius: 4px;

        }
        .active-sidebar-link {
        
            background: var(--hover-gradient); /* Use existing hover background */
            border-radius: 8px;
            margin: 6px 12px;
            transform: translateX(8px);
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1);}

        
    </style>
</head>
<body>
    <div class="bg"></div> 

    <nav class="desktop-sidebar" id="sidebar">
        <div class="sidebar-header">Sidebar Menu</div>
        <ul>
             <li><a href="/"><i></i> Home</a></li>

            <li><a href="/dashboard">Dashboard</a></li>
            <li class="active-sidebar-link"><a href="/myaccount">My Account</a></li>
            <li><a href="/myshipment">My Shipments</a></li>
            <li><a href="/create-shipment">New Shipment</a></li>
            <li><a href="/device-data-stream">Device Data</a></li>
        </ul>
    </nav>
    <div class="main-area">

        <header>
            <div class="logo-container">
                <h2 class="logo">My Account</h2> 
            </div>

            <div id="hamburger" aria-label="Open sidebar" role="button" tabindex="0">
                <span></span>
                <span></span>
                <span></span>
            </div>

            <div class="menu">
                <div class="user-initial" id="headerUserInitial"></div> 
            </div>
        </header>

        <main class="content" role="main">
            <div class="details-container"> 
                <div class="profile-container">
                    <div class="user-initial" id="mainUserInitial">U</div> 
                    <div class="user-info">
                        <h3 id="displayName">Loading...</h3>
                        <p id="displayEmail">Loading...</p>
                    </div>
                </div>

                <div class="account-details">
                    <h4>Account Details</h4>
                    <p>Membership Status: **Active**</p>
                    <p>Last Login: **Today**</p>
                </div>
            </div>

            <div class="help-section">
                <p>Need assistance? Click <a href="#" id="helpLink">Help</a> to send a message to support.</p>

                <div id="messageForm">
                    <form id="contactForm">
                        <p>Send a message to **jaisankar.nb66@gmail.com**:</p>
                        <textarea id="messageText" placeholder="Type your message here..." required></textarea>
                        <button type="submit">Send Message</button>
                    </form>
                    <p id="contactMessage"></p>
                </div>
            </div>

        </main>
    </div>

    <script>
        // ======================================
        // Sidebar Toggle Logic (copied from login.js)
        // ======================================
        const sidebar = document.getElementById("sidebar");
        const hamburger = document.getElementById("hamburger");

        if (hamburger && sidebar) {
            hamburger.addEventListener("click", () => {
                sidebar.classList.toggle("open");
                hamburger.classList.toggle("open");
            });
        }
        
        // ======================================
        // API Fetch and Display Logic
        // ======================================
        async function fetchUserDetails() {
            const userEmail = sessionStorage.getItem('userEmail');

            if (!userEmail) {
                document.getElementById('displayName').textContent = 'Guest User';
                document.getElementById('displayEmail').textContent = 'Please log in.';
                return;
            }

            try {
                const response = await fetch(`http://127.0.0.1:8000/account/me/${userEmail}`);
                const userData = await response.json();

                if (!response.ok) {
                    throw new Error(userData.detail || 'Failed to fetch user details.');
                }

                const userName = userData.name || 'User';
                const initial = userName.charAt(0).toUpperCase();

                // 1. Update Display Fields
                document.getElementById('displayName').textContent = userName;
                document.getElementById('displayEmail').textContent = userData.email;

                // 2. Update Initials (Main View and Header)
                document.getElementById('mainUserInitial').textContent = initial;
                document.getElementById('headerUserInitial').textContent = initial;

            } catch (error) {
                console.error("Error fetching user details:", error);
                document.getElementById('displayName').textContent = 'Error';
                document.getElementById('displayEmail').textContent = 'Could not load details.';
            }
        }
        
        // ======================================
        // Help Anchor and Contact Form Logic (UNCHANGED)
        // ======================================
        const helpLink = document.getElementById('helpLink');
        const messageFormDiv = document.getElementById('messageForm');
        const contactForm = document.getElementById('contactForm');
        const contactMessage = document.getElementById('contactMessage');
        const recipientEmail = "jaisankar.nb66@gmail.com";

        if (helpLink) {
            helpLink.addEventListener('click', (e) => {
                e.preventDefault();
                messageFormDiv.style.display = messageFormDiv.style.display === 'block' ? 'none' : 'block';
                contactMessage.textContent = "";
            });
        }

        if (contactForm) {
            contactForm.addEventListener('submit', (e) => {
                e.preventDefault();
                const messageText = document.getElementById('messageText').value.trim();
                
                if (!messageText) {
                    contactMessage.style.color = 'red';
                    contactMessage.textContent = 'Please enter a message.';
                    return;
                }

                const subject = encodeURIComponent(`Support Request from ${sessionStorage.getItem('userName') || 'User'}`);
                const body = encodeURIComponent(messageText);
                
                window.location.href = `mailto:${recipientEmail}?subject=${subject}&body=${body}`;

                contactMessage.style.color = '#7af58b';
                contactMessage.textContent = 'Your email client should open now. Click "Help" to close this form.';
                
                document.getElementById('messageText').value = '';
            });
        }

        // Initialize on DOMContentLoaded
        document.addEventListener("DOMContentLoaded", fetchUserDetails);
    </script>
</body>
</html>